#ifndef karpador_H
#define karpador_H
const char karpador_source[] =R"shader_source(#version 430
)shader_source"
R"shader_source(layout(location=138)uniform float f;layout(location=139)uniform float v;layout(location=140)uniform float e;layout(location=141)uniform float y;layout(location=142)uniform vec3 m;layout(location=143)uniform float x;layout(location=144)uniform float a;layout(location=145)uniform float z;layout(location=146)uniform float s;layout(location=147)uniform float i;layout(location=148)uniform float M;layout(location=149)uniform vec2 c;layout(location=150)uniform float p;layout(location=151)uniform float r;layout(location=152)uniform float d;layout(location=153)uniform vec2 n;layout(location=64)uniform float t;layout(location=117)uniform float l;layout(location=154)uniform float S;layout(location=155)uniform float h;layout(location=156)uniform float k;layout(location=157)uniform float o;layout(location=158)uniform vec2 b;layout(location=159)uniform vec3 w;layout(location=160)uniform float u;layout(location=161)uniform float g;layout(location=162)uniform float W;layout(location=163)uniform float q;layout(location=164)uniform float I;layout(location=165)uniform float F;layout(location=166)uniform float L;layout(location=65)uniform float C;layout(location=167)uniform float D;
)shader_source"
R"shader_source(#line 3"fragment"
)shader_source"
R"shader_source(out vec3 Z;out float Y;layout(location=0)uniform vec2 X;layout(location=66)uniform float V;
)shader_source"
R"shader_source(#line 2"quat_rotate"
)shader_source"
R"shader_source(vec3 U[12]=vec3[12](vec3(1,1,0),vec3(-1,1,0),vec3(1,-1,0),vec3(-1,-1,0),vec3(1,0,1),vec3(-1,0,1),vec3(1,0,-1),vec3(-1,0,-1),vec3(0,1,1),vec3(0,-1,1),vec3(0,1,-1),vec3(0,-1,-1));
)shader_source"
R"shader_source(#line 4"camera"
)shader_source"
R"shader_source(layout(location=67)uniform vec3 T;layout(location=68)uniform vec4 R;layout(location=69)uniform float Q;layout(location=70)uniform float P;float O=Q/P;
)shader_source"
R"shader_source(#line 2"helper"
)shader_source"
R"shader_source(const float N=3.14159,K=6.28319,J=2.71828,H=1.61803,G=1000.,E=1./0.;
)shader_source"
R"shader_source(#line 4"sdf/domain"
)shader_source"
R"shader_source(#line 3"sdf/operators"
)shader_source"
R"shader_source(#line 4"material"
)shader_source"
R"shader_source(struct MaterialId{float id;vec3 coord;vec4 misc;};struct MatWrap{float f;MaterialId m;};struct Material{vec3 color;float roughness;float metallic;float height;vec3 emission;};bool B=false;float A=G;MaterialId j=MaterialId(0.,vec3(0.),vec4(0.));
)shader_source"
R"shader_source(#line 5"sdf/distances"
)shader_source"
R"shader_source(#line 4"lighting"
)shader_source"
R"shader_source(layout(binding=0)uniform sampler2D ab;layout(binding=1)uniform samplerCube ac;layout(binding=2)uniform samplerCube ad;layout(binding=3)uniform samplerCube ae;struct SphereLight{vec3 position;float radius;vec3 color;float power;};
)shader_source"
R"shader_source(#line 11"march"
)shader_source"
R"shader_source(layout(location=132)uniform float af;layout(location=133)uniform float ag;layout(location=134)uniform vec3 ah;layout(location=135)uniform float ai;const float aj=423.;bool ak=true,al=false,am=false,an=false,ao=false,ap=false,aq=false,ar=ak,as=al;layout(location=136)uniform float at;
)shader_source"
R"shader_source(#line 3
)shader_source"
R"shader_source(const float au=0.,av=1.,aw=2.,ax=4.,ay=5.,az=6.,ba=7.,bb=8.,bc=9.;layout(location=168)uniform float bd;const float be=-bd,bf=.5*bd,bg=bd,bh=-.5*bd,bi=bd,bj=-bd;void bk(inout vec3 f,vec4 v){vec3 a=2*cross(v.xyz,f);f+=v.w*a+cross(v.xyz,a);}uint bk(uint f){return f=f+2127912214+(f<<12),f=f^-949894596^f>>19,f=f+374761393+(f<<5),f=f+-744332180^f<<9,f=f+-42973499+(f<<3),f=f^-1252372727^f>>16,f;}float bl(uint v){return float(v%(1<<20))/float(1<<20);}float bm(int v){return bl(bk(v));}float bn(ivec2 v){return bl(bk(v.x+bk(v.y)));}float bo(ivec3 v){return bl(bk(v.x+bk(v.y+bk(v.z))));}float bp(float v){int f=int(floor(v));float a=fract(v),i=bo(f),x=bo(f+1);return mix(i,x,a);}float bq(vec2 v){ivec2 f=ivec2(floor(v));vec2 a=fract(v);float d=0,i=bo(f),x=bo(f+ivec2(0,1)),e=bo(f+ivec2(1,0)),n=bo(f+ivec2(1,1));return mix(mix(i,e,a.x),mix(x,n,a.x),a.y)*2.-1.;}float br(vec3 v){ivec3 f=ivec3(floor(v));vec3 a=fract(v);float d=0,i=bo(f),x=bo(f+ivec3(0,1,0)),e=bo(f+ivec3(1,0,0)),n=bo(f+ivec3(1,1,0)),l=bo(f+ivec3(0,0,1)),z=bo(f+ivec3(0,1,1)),y=bo(f+ivec3(1,0,1)),b=bo(f+ivec3(1,1,1));return mix(mix(mix(i,e,a.x),mix(x,n,a.x),a.y),mix(mix(l,y,a.x),mix(z,b,a.x),a.y),a.z)*2.-1.;}float bs(vec2 f){float a=.5*(sqrt(3.)-1.);ivec2 v=ivec2(floor(f+(f.x+f.y)*a));float y=(3.-sqrt(3.))/6.;f-=v-(v.x+v.y)*y;ivec2 d=f.x>f.y?ivec2(1,0):ivec2(0,1);vec2 b[3]=vec2[3](f,f-d+y,f-1.+2.*y);ivec3 i=ivec3(v.x)+ivec3(0,d.x,1),n=ivec3(v.y)+ivec3(0,d.y,1);float r=0;for(uint l=0;l<3;l++){float m=max(0,.5-b[l].x*b[l].x-b[l].y*b[l].y);m*=m;uint c=bk(i[l]+bk(n[l]))%12;r+=m*m*dot(U[c].xy,b[l]);}return 70.*r;}float bt(vec3 f){float a=1./3.,v=1./6.;ivec3 d=ivec3(floor(f+(f.x+f.y+f.z)*a));f-=d-(d.x+d.y+d.z)*v;vec3 y=step(f.yzx,f);ivec3 n=ivec3(min(y,(1.-y).zxy)),x=ivec3(max(y,(1.-y).zxy));vec3 b[4]=vec3[4](f,f-n+v,f-x+2.*v,f-1.+3.*v);int i[4]=int[4](d.x,d.x+n.x,d.x+x.x,d.x+1),l[4]=int[4](d.y,d.y+n.y,d.y+x.y,d.y+1),m[4]=int[4](d.z,d.z+n.z,d.z+x.z,d.z+1);float r=0;for(uint c=0;c<4;c++){float e=max(0.,.6-b[c].x*b[c].x-b[c].y*b[c].y-b[c].z*b[c].z);e*=e;uint z=bk(i[c]+bk(l[c]+bk(m[c])))%12;r+=e*e*dot(U[z],b[c]);}return 32.*r;}float bu(vec2 f){float a=0.;for(int r=0;r<3;r++)a+=exp2(-r)*br(f),f*=2.;return a/1.75;}float bv(vec3 f){float a=0.;for(int r=0;r<3;r++)a+=exp2(-r)*br(f),f*=2.;return a/1.75;}float bw(vec2 f){float a=0.;for(int r=0;r<3;r++)a+=exp2(-r)*bt(f),f*=2.;return a/1.75;}float bx(vec3 f){float a=0.;for(int r=0;r<3;r++)a+=exp2(-r)*bt(f),f*=2.;return a/1.75;}vec3 bl(vec2 v,out float f){vec3 a=vec3((v-.5*X)/X.x,Q/P);f=length(a.xz);a=normalize(a);return a;}vec3 bk(){vec2 a=vec2(bt(vec2(V*C,23)),bt(vec2(V*C,283)))*t;vec3 v=bl(gl_FragCoord.xy+a*X,O);v.z=-v.z;bk(v,R);return v;}float by(float f){return.5*f/(O*X.x);}float bz(vec2 f){return min(f.x,f.y);}float ca(vec3 f){return min(min(f.x,f.y),f.z);}float cb(vec2 f){return max(f.x,f.y);}float cc(vec3 f){return max(max(f.x,f.y),f.z);}float bk(float v,float f,float a){return min(min(v,f),a);}float bk(float v,float f,float a,float d){return min(min(min(v,f),a),d);}float bl(float v,float f,float a){return max(max(v,f),a);}float bl(float v,float f,float a,float d){return max(max(max(v,f),a),d);}float cd(vec2 f){return f.x+f.y;}float ce(vec3 f){return f.x+f.y+f.z;}float cf(vec2 f){return f.x*f.y;}float cg(vec3 f){return f.x*f.y*f.z;}float ch(float f){return f*f;}vec2 ci(vec2 f){return f*f;}vec3 cj(vec3 f){return f*f;}float ck(float f){return 1./f;}vec2 cl(vec2 f){return 1./f;}vec3 cm(vec3 f){return 1./f;}float bm(vec2 v,float f){return pow(ce(pow(abs(v),vec2(f))),1./f);}float bn(vec3 v,float f){return pow(ce(pow(abs(v),vec3(f))),1./f);}float cn(float v){return clamp(v,0.,1.);}vec2 co(vec2 v){return clamp(v,0.,1.);}vec3 cp(vec3 v){return clamp(v,0.,1.);}float bm(float f,float v,float y){return clamp((y-f)/(v-f),0.,1.);}float bn(float f,float v,float y){float a=clamp((y-f)/(v-f),0.,1.);return a*a*a*(a*(a*6.-15.)+10.);}float bo(vec2 v,vec2 f){return max(0.,dot(v,f));}float bp(vec3 v,vec3 f){return max(0.,dot(v,f));}float cq(float f){return f<0.?-1.:1.;}vec2 cr(vec2 f){return vec2(f.x<0.?-1.:1.,f.y<0.?-1.:1.);}vec3 cs(vec3 f){return vec3(f.x<0.?-1.:1.,f.y<0.?-1.:1.,f.z<0.?-1.:1.);}vec2 ct(float v){return vec2(cos(v),sin(v));}vec3 bq(float v,float f){float a=cos(f),y=sin(v),i=sin(f),x=cos(v);return vec3(i*x,a,i*y);}float bo(float f,float v,float a){if(a>f)return a;float i=2.*v-f,y=2.*f-3.*v,n=a/f;return(i*n+y)*n*n+v;}float br(float f,float v){float a=f*v;return a*exp(1.-a);}float bp(float f,float v,float a){return a=abs(a-f),a/=v,1.-smoothstep(0.,1.,a);}float bq(float f,float v,float a){return exp(-f*pow(a,v));}float bs(float f,float v){return pow(4.*v*(1.-v),f);}float br(float f,float v,float a){float i=pow(f+v,f+v)/(pow(f,f)*pow(v,v));return i*pow(a,f)*pow(1.-a,v);}float bs(float f,float v,float a){return pow(a,f)*pow(1.-a,v);}float cu(vec3 v){return dot(v,vec3(.2126,.7152,.0722));}vec3 cv(vec3 f){vec4 v=vec4(0.,-1./3.,2./3.,-1.),a=mix(vec4(f.zy,v.wz),vec4(f.yz,v.xy),step(f.z,f.y)),d=mix(vec4(a.xyw,f.x),vec4(f.x,a.yzx),step(a.x,f.x));float b=d.x-min(d.w,d.y),y=1e-10;return vec3(abs(d.z+(d.w-d.y)/(6.*b+y)),b/(d.x+y),d.x);}vec3 cw(vec3 f){vec4 v=vec4(1.,2./3.,1./3.,3.);vec3 a=abs(fract(f.xxx+v.xyz)*6.-v.www);return f.z*mix(v.xxx,clamp(a-v.xxx,0.,1.),f.y);}void bt(inout float f,float v){f-=v;}void bu(inout vec2 f,vec2 v){f-=v;}void bt(inout vec2 v,float f,float a){bm(v,vec2(f,a));}void bv(inout vec3 f,vec3 v){f-=v;}void bm(inout vec3 v,float f,float a,float d){bm(v,vec3(f,a,d));}void bw(inout vec2 f,float v){f*=mat2(cos(v),sin(v),-sin(v),cos(v));}void bx(inout vec3 v,float f){bw(v.yz,f);}void by(inout vec3 v,float f){bw(v.zx,f);}void bz(inout vec3 v,float f){bw(v.xy,f);}float ca(inout float f,float v){f+=.5*v;float a=floor(f/v);f=mod(f,v)-.5*v;return a;}vec2 cb(inout vec2 f,vec2 v){f+=.5*v;vec2 a=floor(f/v);f=mod(f,v)-.5*v;return a;}vec2 bu(inout vec2 v,float f,float a){return bn(v,vec2(f,a));}vec3 cc(inout vec3 f,vec3 v){f+=.5*v;vec3 a=floor(f/v);f=mod(f,v)-.5*v;return a;}vec3 bn(inout vec3 v,float f,float a,float d){return bn(v,vec3(f,a,d));}void cd(inout float f,float v){f*=mod(v,2.)*2.-1.;}void ce(inout vec2 f,vec2 v){f*=mod(v,2.)*2.-1.;}void cf(inout vec3 f,vec3 v){f*=mod(v,2.)*2.-1.;}float cg(inout float v,float f){float a=bn(v,f);v*=mod(a,2.)*2.-1.;return a;}vec2 ch(inout vec2 v,vec2 f){vec2 a=bn(v,f);v*=mod(a,2.)*2.-1.;return a;}vec3 ci(inout vec3 v,vec3 f){vec3 a=bn(v,f);v*=mod(a,2.)*2.-1.;return a;}vec2 cj(inout vec2 v,vec2 f){vec2 a=ci(v,f);v-=.5*f;if(v.x>v.y)v.xy=v.yx;return floor(.5*a);}vec3 ck(inout vec3 c,vec3 f){vec3 a=ci(c,f);c-=.5*f;if(c.x<c.y){if(c.y>c.z){if(c.x<c.z)c=c.xzy;else c=c.zxy;}}else{if(c.z<c.y)c=c.zyx;else{if(c.z<c.x)c=c.yzx;else c=c.yxz;}}return floor(.5*a);}float cl(inout float f,float v){float a=.5*v,i=0.;if(f>a)f+=a,i=floor(f/v),f=mod(f,v)-a;return i;}vec2 cm(inout vec2 f,vec2 v){vec2 a=.5*v,d=vec2(0.);if(f.x>a.x)f.x+=a.x,d.x=floor(f.x/v.x),f.x=mod(f.x,v.x)-a.x;if(f.y>a.y)f.y+=a.y,d.y=floor(f.y/v.y),f.y=mod(f.y,v.y)-a.y;return d;}vec3 cn(inout vec3 f,vec3 v){vec3 a=.5*v,d=vec3(0.);if(f.x>a.x)f.x+=a.x,d.x=floor(f.x/v.x),f.x=mod(f.x,v.x)-a.x;if(f.y>a.y)f.y+=a.y,d.y=floor(f.y/v.y),f.y=mod(f.y,v.y)-a.y;if(f.z>a.z)f.z+=a.z,d.z=floor(f.z/v.z),f.z=mod(f.z,v.z)-a.z;return d;}float bo(inout float f,float v,float a,float d){f+=.5*v;float i=floor(f/v);f=mod(f,v)-.5*v;if(i>d)f+=v*(i-d),i=d;else if(i<a)f+=v*(i-a),i=a;return i;}vec2 bp(inout vec2 f,vec2 v,vec2 a,vec2 d){f+=.5*v;vec2 i=floor(f/v);f=mod(f,v)-.5*v;if(i.x>d.x)f.x+=v.x*(i.x-d.x),i.x=d.x;else if(i.x<a.x)f.x+=v.x*(i.x-a.x),i.x=a.x;if(i.y>d.y)f.y+=v.y*(i.y-d.y),i.y=d.y;else if(i.y<a.y)f.y+=v.y*(i.y-a.y),i.y=a.y;return i;}vec3 bq(inout vec3 f,vec3 v,vec3 a,vec3 d){f+=.5*v;vec3 i=floor(f/v);f=mod(f,v)-.5*v;if(i.x>d.x)f.x+=v.x*(i.x-d.x),i.x=d.x;else if(i.x<a.x)f.x+=v.x*(i.x-a.x),i.x=a.x;if(i.y>d.y)f.y+=v.y*(i.y-d.y),i.y=d.y;else if(i.y<a.y)f.y+=v.y*(i.y-a.y),i.y=a.y;if(i.z>d.z)f.z+=v.z*(i.z-d.z),i.z=d.z;else if(i.z<a.z)f.z+=v.z*(i.z-a.z),i.z=a.z;return i;}float br(inout vec2 f,float v,float a,float d){float i=d,y=K/v,n=bn(i,y),m=length(f);f=m*bq(i);bm(f.x,a);return n;}float bv(inout vec2 f,float v,float a){return br(f,v,a,atan(f.y,f.x));}float bw(inout vec2 f,float v,float a){float i=length(f),d=floor(i/v);i=mod(i,v);f=i*bq(a);return d;}float co(inout vec2 f,float v){return bw(f,v,atan(f.y,f.x));}float cx(inout float f){float a=cs(f);f=abs(f);return a;}vec2 cy(inout vec2 f){vec2 a=cs(f);f=abs(f);return a;}vec3 cz(inout vec3 f){vec3 a=cs(f);f=abs(f);return a;}float cp(inout float v,float f){float a=cz(v);bm(v,f);return a;}vec2 cq(inout vec2 v,vec2 f){vec2 a=cz(v);bm(v,f);return a;}vec3 cr(inout vec3 v,vec3 f){vec3 a=cz(v);bm(v,f);return a;}vec3 cs(inout vec2 f,vec2 v){vec3 c;c.xy=cr(f,v);if(f.y>f.x)c.z=-1.,f.xy=f.yx;else c.z=1.;return c;}vec3 ct(inout vec3 f,vec3 v){f=f.zyx;vec3 a=cr(f,v);if(f.x<f.y){if(f.y>f.z){if(f.x<f.z)f=f.xzy;else f=f.zxy;}}else{if(f.z<f.y)f=f.zyx;else{if(f.z<f.x)f=f.yzx;else f=f.yxz;}}f=f.zyx;return a;}vec2 cu(inout vec2 f,float v){vec2 a=f;cz(a);vec2 d=vec2(0);if(a.y>a.x)f=f.yx,d.x=1;d.y=cr(f.x,v);f.y*=d.y;return d;}vec2 cv(inout vec3 f,float v){vec3 a=f;cz(a);vec2 d=vec2(0);if(a.z>a.x||a.y>a.x){if(a.y>a.z)f=f.yxz,d.x=1;else f=f.zyx,d.x=2;}d.y=cr(f.x,v);f.y*=d.y;return d;}float bx(inout vec3 f,vec3 v,float a){float i=dot(f,v)+a;if(i<0.)f-=2.*i*v;return cs(i);}float by(inout vec3 f,vec3 v,vec3 a){bm(f,v);float d=cp(dot(f,a)/dot(a,a));f-=a*d;bm(f,-v);return d;}void da(inout float f){f=-f;}void db(inout vec2 f){f=-f;}void dc(inout vec3 f){f=-f;}float bz(float f,float v,float a){if(f<a&&v<a){float d=clamp(.5+.5*(v-f)/a,0.,1.),i=mix(v,f,d)-a*d*(1.-d);return i;}float i=min(f,v);return i;}float ca(float f,float v,float a){if(abs(f)<a&&abs(v)<a){float d=clamp(.5-.5*(v-f)/a,0.,1.),i=mix(v,f,d)+a*d*(1.-d);return i;}float d=max(f,v);return d;}float cb(float v,float f,float a){return ca(v,-f,a);}float cc(float v,float f,float a){return bz(v,f,a);}float cd(float v,float f,float a){return ca(v,f,a);}float ce(float v,float f,float a){float d=min(v,f);if(v<a&&f<a){vec2 y=vec2(v,f),i=vec2(a);float e=a-distance(i,y);return min(e,d);}return d;}float cf(float v,float f,float a){float d=max(v,f);if(v>-a&&f>-a){vec2 y=vec2(v,f),i=vec2(-a);float e=distance(i,y)-a;return max(e,d);}return d;}float cg(float v,float f,float a){return cf(v,-f,a);}float ch(float f,float v,float a){float d=min(f,v),i=sqrt(.5)*(f+v-a);return min(i,d);}float ci(float f,float v,float a){float d=max(f,v),i=sqrt(.5)*(f+v+a);return max(i,d);}float cj(float v,float f,float a){return ci(v,-f,a);}float ck(float f,float v,float a){float d=min(f,v),i=sqrt(.5)*(f+v-a);return bz(i,d,.1*a);}float cl(float f,float v,float a){float d=max(f,v),i=sqrt(.5)*(f+v+a);return ca(i,d,.1*a);}float cm(float v,float f,float a){return cl(v,-f,a);}float bs(float v,float f,float a,float d){float y=min(v,f);if(v<2.*a&&f<2.*a){vec2 i=vec2(v,f);float e=sqrt(.5)*a/(d+sqrt(.5)-1.);i.y-=a-e;bw(i,-K/8.);bq(i.x,2.*e,0.,d-1.);float r=length(i)-e;r=min(r,i.y);return min(r,y);}return y;}float bt(float v,float f,float a,float d){float y=max(v,f);if(v>-a&&f>-a){vec2 i=vec2(v,f);float e=sqrt(.5)*a/(d+sqrt(.5)-1.);i.x-=-a;i.y-=-e;bw(i,-K/8.);bq(i.x,2.*e,0.,d-1.);float r=length(i)-e;r=min(r,i.y);return max(r,y);}return y;}float bu(float v,float f,float a,float d){return bt(v,-f,a,d);}float bv(float v,float f,float a,float d){float y=min(v,f);vec2 i=vec2(v,f);float m=a/d*sqrt(.5);i.y-=a-sqrt(.5)*m;i.x-=sqrt(.5)*m;bw(i,-K/8.);bn(i.x,2.*m);i.x=abs(i.x);float n=m*sqrt(.5),r=dot(i,vec2(sqrt(.5)))-n;r=min(r,i.y);return min(r,y);}float bw(float f,float v,float a,float d){return-bv(-f,-v,a,d);}float bx(float v,float f,float a,float d){return bw(v,-f,a,d);}float cw(float v,float f){vec2 a=vec2(v,f);return max(ca(a),0.)-length(min(a,0.));}float cx(float v,float f){vec2 a=vec2(v,f);return min(cc(a),0.)+length(max(a,0.));}float cy(float v,float f){return cx(v,-f);}void cz(float f,MaterialId v){if(B){if(f<A)A=f,j=v;}else A=min(A,f);}void dd(MatWrap f){da(f.f,f.m);}MatWrap da(MatWrap f,MatWrap v){return f.f<v.f?f:v;}MatWrap db(MatWrap f,MatWrap v){return f.f>v.f?f:v;}MatWrap dc(MatWrap v,MatWrap f){return f.f=-f.f,dd(v,f);}void dd(float f,MaterialId v){if(B){if(f>A)A=f,j=v;}else A=max(A,f);}MaterialId de(float v,vec3 f){return MaterialId(v,f,vec4(0.));}Material de(vec3 v){return Material(v,.5,0,0,vec3(0));}void by(float f,MaterialId v,float a,float i){float d=A,e=sqrt(.5)*(d+f-a);da(f,v);da(e,de(i,vec3(d,f,0.)));}void bk(float f,MaterialId v,float a,float d,float i){float e=A;vec2 r=vec2(e,f);float y=a/d*sqrt(.5);r.y-=a-sqrt(.5)*y;r.x-=sqrt(.5)*y;bw(r,-K/8.);bn(r.x,2.*y);r.x=abs(r.x);float n=y*sqrt(.5),l=dot(r,vec2(sqrt(.5)))-n;l=min(l,r.y);da(f,v);da(l,de(i,vec3(r,0.)));}void bz(MatWrap f,float v,float a,float d){bl(f.f,f.m,v,a,d);}void ca(float f,MaterialId v,float a,float i){float d=A;if(d<a&&f<a){float y=clamp(.5+.5*(f-d)/a,0.,1.),m=mix(f,d,y)-a*y*(1.-y);A=m;j=de(i,vec3(d,f,y));}da(f,v);}MatWrap cb(MatWrap f,MatWrap v,float a,float i){MatWrap d=da(f,v);float e=sqrt(.5)*(f.f+v.f-a);return da(d,MatWrap(e,de(i,vec3(f.f,v.f,0.))));}MatWrap cc(MatWrap f,MatWrap v,float a,float i){float d=f.f,x=v.f;if(d<a&&x<a){float y=clamp(.5+.5*(x-d)/a,0.,1.),e=mix(x,d,y)-a*y*(1.-y);return MatWrap(e,de(i,vec3(d,x,0.)));}MatWrap n=da(f,v);return n;}MatWrap bl(MatWrap f,MatWrap v,float a,float d,float i){float e=f.f,y=v.f;vec2 r=vec2(e,y);float m=a/d*sqrt(.5);r.y-=a-sqrt(.5)*m;r.x-=sqrt(.5)*m;bw(r,-K/8.);bn(r.x,2.*m);r.x=abs(r.x);float n=m*sqrt(.5),l=dot(r,vec2(sqrt(.5)))-n;l=min(l,r.y);MatWrap x=MatWrap(l,de(i,vec3(r,0.))),c=da(f,v);c=da(c,x);return c;}float df(vec3 f,float v){return length(f)-v;}float dg(vec2 f,float v){return length(f)-v;}float cn(vec3 f,float v,float a){float i=dg(f.xz,v),y=abs(f.y)-a;return cx(i,y);}float co(vec3 f,float v,float a){float i=dg(f.xz,v),y=abs(f.y)-a;return max(i,y);}float df(vec3 f){return min(cc(f),0.)+length(max(f,0.));}float dh(vec3 f,float v){return df(f+v)-v;}float dg(vec3 f){return cc(f);}float dh(vec2 f){return min(cc(f),0.)+length(max(f,0.));}float di(vec2 f,float v){return dh(f+v)-v;}float di(vec2 f){return cc(f);}float dj(vec3 f,vec3 v){vec3 a=abs(f)-v;return min(cc(a),0.)+length(max(a,0.));}float cd(vec3 f,float v,float a,float d){return dk(f,vec3(v,a,d));}float dk(vec3 f,float v){return dk(f,vec3(v));}float cp(vec3 f,vec3 v,float a){return dk(f,v-a)-a;}float cq(vec3 f,float v,float a){return cq(f,vec3(v),a);}float dl(vec3 f,vec3 v){return cc(abs(f)-v);}float ce(vec3 f,float v,float a,float d){return dm(f,vec3(v,a,d));}float dm(vec3 f,float v){return dm(f,vec3(v));}float dn(vec2 f,vec2 v){vec2 a=abs(f)-v;return min(cc(a),0.)+length(max(a,0.));}float cr(vec2 f,float v,float a){return do(f,vec2(v,a));}float do(vec2 f,float v){return do(f,vec2(v));}float cs(vec2 f,vec2 v,float a){return do(f,v-a)-a;}float ct(vec2 f,float v,float a){return ct(f,vec2(v),a);}float dp(vec2 f,vec2 v){return cc(abs(f)-v);}float cu(vec2 f,float v,float a){return dq(f,vec2(v,a));}float dq(vec2 f,float v){return dq(f,vec2(v));}float dr(vec3 f,vec3 v){return dot(f,v);}float cv(vec3 f,float v,float a){return dr(f,bq(v,a));}float ds(vec2 f,vec2 v){return dot(f,v);}float dt(vec2 f,float v){return ds(f,bq(v));}float du(vec2 f,float v){return max(dt(vec2(abs(f.x),f.y),radians(30)),-f.y)-.5*v;}float cw(vec3 f,float v,float a){float i=du(f.xz,v),y=abs(f.y)-a;return cx(i,y);}float cx(vec3 f,float v,float a){float i=du(f.xz,v),y=abs(f.y)-a;return max(i,y);}float dv(vec2 f,float v){float a=v*sqrt(.5);vec2 i=abs(f);float d=ds(i,vec2(sqrt(.5)))-a;return d;}float dw(vec2 f,float v){float a=radians(54.),y=radians(-18.),d=v*cos(K/5./2.);vec2 i=vec2(abs(f.x),f.y);float e=dt(i,a),x=-f.y,n=dt(i,y),m=bl(e,x,n)-d;return m;}float cy(vec3 f,float v,float a){float i=dw(f.xz,v),y=abs(f.y)-a;return cx(i,y);}float cz(vec3 f,float v,float a){float i=dw(f.xz,v),y=abs(f.y)-a;return max(i,y);}float dx(vec2 f,float v){float a=v*cos(K/6./2.);vec2 i=abs(f);float d=dt(i,radians(30.)),y=i.y,n=max(d,y)-a;return n;}float da(vec3 f,float v,float a){float i=dx(f.xz,v),y=abs(f.y)-a;return cx(i,y);}float db(vec3 f,float v,float a){float i=dx(f.xz,v),y=abs(f.y)-a;return max(i,y);}float bk(vec2 f,float v,float a,float d,float y,float i,float m){float x=atan(f.y,f.x),n=length(f),l=d/4.,e=cos(l*x),b=sin(l*x),c=e/v,r=b/a,z=c<0.?-1.:1.,s=r<0.?-1.:1.,M=c*z,K=r*s,t=pow(M,i),A=pow(K,m),N=t/M,Z=A/K,j=t+A,p=pow(j,-1./y),g=-i*N*z/v*b,S=m*Z*s/a*e,F=l/y*p/j,w=F*F*(g*g+2.*g*S+S*S),o=(n-p)/sqrt(1+w);return o;}float dc(vec3 f,float v,float a){vec2 i=vec2(dg(f.xz,v),f.y);return dg(i,a);}float dy(vec3 f,vec2 v){return dy(f,v.x,v.y);}float dd(vec3 f,float v,float a){vec2 i=vec2(dq(f.xz,v),f.y);return do(i,a);}float de(vec3 f,float v,float a){vec2 i=vec2(dg(f.xz,v),f.y);return do(i,a);}float cf(vec3 f,float v,float a,float d){float m=length(f.xz),i=atan(f.z,f.x);i-=clamp(i,-d,d);f.xz=m*bq(i);f.x-=v;return df(f,a);}float dz(vec3 f,vec2 v){vec2 a=vec2(length(f.xz),f.y);return ds(a,v);}float ea(vec3 f,float v){vec2 e=vec2(length(f.xz),f.y);return dt(e,v);}float cg(vec3 f,float v,float e,float y){float m=v-e,x=2*y,a=sqrt(m*m+x*x);vec2 z=vec2(x/a,m/a);vec3 s=f;bm(s.y,e*z.x/z.y+y);float i=dz(s,z),M=abs(f.y)-y;return max(i,M);}float df(vec3 f,float v,vec3 e){float y=cp(dot(f,e)/dot(e,e));return df(f-e*y,v);}float dg(vec3 f,float v,float e){return f.x-=clamp(f.x,-e,e),df(f,v);}float ch(vec3 f,float v,float e,vec2 y){float m=v*y.x/y.y;f.x=abs(f.x);f.x-=min(e,f.x);f.x-=m;return dz(f.yxz,y);}float ci(vec3 f,float v,float e,float y){return ch(f,v,e,bq(y));}float eb(vec3 f,float v){vec3 e=abs(f);e.y-=v;float y=ds(e.xy,vec2(.816497,.57735)),m=ds(e.zy,vec2(.816497,.57735)),x=max(y,m);return x;}float dh(vec3 f,float v,float e){float y=length(f.xz),m=atan(f.z,f.x);y-=m*v/K;vec2 x=vec2(y,f.y);bn(x.x,v);float a=dg(x,e);return a;}float di(vec2 f,float v,float e){vec2 y=f,m=f;y.x-=v;m.x-=-v;float x=length(y)+length(m);x=x*.5-e;return x;}float dj(vec3 f,float v,float e){vec3 y=f,m=f;y.x-=v;m.x-=-v;float x=length(y)+length(m);x=x*.5-e;return x;}float dk(vec3 f,float v,float e){vec3 y=f;y.xz=abs(y.xz);y.y-=v;float m=dt(y.xy,e),x=dt(y.zy,e),a=max(m,x);return a;}vec3 cj(vec3 f,vec3 v,float e,float y){float m=cp(1-y);return normalize(mix(f,v,m*(sqrt(m)+y)));}vec3 ck(vec3 f,vec3 v,vec3 e,float y){float m=cp(dot(f,v));vec3 x=2.*dot(f,v)*f-v,a=cj(f,x,m,sqrt(y)),z=textureLod(ae,a,sqrt(y)*5.).xyz;vec2 s=textureLod(ab,vec2(y,m),0.).xy;return z*(e*s.x+s.y);}vec3 dl(vec3 f,vec3 v,Material e){vec3 y=textureLod(ad,f,0.).xyz,m=e.color*y+ck(f,v,vec3(.04),e.roughness),x=ck(f,v,e.color,e.roughness);return mix(m,x,e.metallic);}vec3 dm(vec3 f,vec3 v,float e){f.xz-=T.xz;float y=cj(dot(v,f))-dot(f,f)+e*e,m=-dot(v,f)+sqrt(y);return textureLod(ac,normalize(f+m*v),0.).xyz;}vec3 bk(vec3 f,float v,vec3 e,vec3 y,vec3 m,Material x){return x.color=.5*m+.5,dl(m,-e,x);}float dn(vec3 f,vec3 v,SphereLight e){vec3 y=e.position-f;float m=dot(y,y);vec3 x=y*inversesqrt(m);float a=acos(dot(v,x)),z=sqrt(m),s=z/e.radius,i=sqrt(cj(s)-1),M=-i/tan(a),c=0;if(s*cos(a)>1)c=cos(a)/cj(s);else c=1./(N*cj(s))*(cos(a)*acos(M)-i*sin(a)*sqrt(1-M*M))+1/N*atan(sin(a)*sqrt(1-cj(M))/i);c*=N;return c;}vec3 bm(vec3 f,vec3 v,vec3 e,float y,SphereLight m){vec3 x=reflect(-e,v),a=cj(v,x,bp(v,e),y),z=m.position-f,s=dot(z,a)*a-z,i=z+s*cp(m.radius/length(s));return i;}float ec(float f,float v){float e=cj(v),y=(1-e)/e*f;return sqrt(1+y);}float cl(vec3 f,vec3 v,vec3 e,float y){vec3 m=normalize(f+v);float x=bp(e,v),a=bp(e,f),z=bp(e,m),s=cj(y),i=cj(s),M=max(N*cj(cj(z)*(i-1)+1),1e-08);M*=ec(i,a)+ec(i,x);M*=2*x*a;return max(i/M,0);}vec3 do(vec3 f,vec3 v,vec3 e){vec3 y=normalize(f+v);float m=bp(f,y);return e+(1-e)*exp2((-5.55473*m-6.98316)*m);}vec3 bl(vec3 f,float v,vec3 e,vec3 y,vec3 m,Material x,SphereLight a){vec3 z=a.position-y;float s=dot(z,z);z/=sqrt(s);float i=bp(z,m),M=a.power/(4*cj(N)*cj(a.radius));M*=dn(y,m,a);vec3 c=x.color*(max(0,i*M)/N),p=bm(y,m,-e,x.roughness,a);float r=cp(x.roughness+a.radius/(2*sqrt(s))),d=dot(p,p);p/=sqrt(d);float n=cj(x.roughness/r),t=a.power*n/(4*N*d);vec3 l=do(-e,p,x.color);float S=t*i*cl(-e,p,m,x.roughness);vec3 h=do(-e,p,vec3(.04));return mix(c+h*S,S*l,x.metallic);}float dj(vec3 f){return abs(dr(f,normalize(ah))-ai);}void bl(){int f=int(ag);if(f==0)ak=true,al=false,am=false,an=false,ao=false,ap=false,aq=false;else if(f==1)ak=true,al=true,am=true,an=false,ao=false,ap=false,aq=false;else if(f==2)ak=false,al=true,am=true,an=false,ao=false,ap=false,aq=false;else if(f==3)ak=true,al=false,am=false,an=false,ao=true,ap=true,aq=false;else if(f==4)ak=true,al=true,am=true,an=false,ao=true,ap=true,aq=false;else if(f==5)ak=false,al=true,am=true,an=false,ao=true,ap=true,aq=false;else ak=true,al=false,am=false,an=false,ao=false,ap=false,aq=false;ar=ak;as=al;}vec3 dp(float f,vec3 v,float e){float y=abs(sin(N*10.*f));y=1.-(1.-smoothstep(8.,15.,e))*(1.-y);float m=abs(sin(N*f));m=1.-(.8+.2*smoothstep(6.,10.,e))*(1.-smoothstep(60.,80.,e))*(1.-m);float x=abs(sin(N/10.*f));x=1.-(.8+.2*smoothstep(30.,50.,e))*(1.-smoothstep(80.,150.,e))*(1.-x);float a=dj(v);vec3 z=vec3(0.),s=vec3(.29804,.18824,.43922),i=vec3(.12549,.52941,.36078),M=vec3(.02095,.19046,.60548),c=mix(s,i,smoothstep(.1*a,a,f));if(f<0.)c=M;c=cv(c);c.y*=1.-smoothstep(a,10.*a,abs(f));c=cw(c);c=mix(z,c,y);c=mix(z,c,m);c=mix(z,c,x);return c;}void dq(vec3 f,inout vec3 v,float e){vec3 y=dFdx(f),m=dFdy(f),x=cross(m,v),a=cross(v,y);float z=dot(y,x),s=dFdx(e),i=dFdy(e);vec3 M=(s*x+i*a)*sign(z),c=normalize(abs(z)*v-M);v=c;}float dr(vec3 f,float v,float e){vec2 y=vec2(dg(f.xz,v),f.y);bw(y,K*bf);return ct(y,vec2(1.,.5)*e,S);}MatWrap ds(vec3 f,float v,float e){ct(f.zx,vec2(sin(e)*v));bx(f,-e);float y=I,m=length(f.xy)-y*bd*g;bn(m,y);float x=bp(0.,M,m),a=-f.z-i*x;return MatWrap(a,MaterialId(au,f,vec4(x,0.,0.,0.)));}MatWrap dk(vec3 f){float v=f.y-o;MatWrap e=MatWrap(v,de(av,f));vec3 y=f;y.y-=o;float m=db(y,b.x,b.y);vec2 x=vec2(m,y.y);ct(x,vec2(0.));bw(x,K*bg);m=dq(x,1.);MatWrap a=MatWrap(m,de(aw,y));f.y-=50.;ct(f.zyx,w.yzx);cr(f,w);by(f,K*u);MatWrap z=ds(f,W,K*h);z=da(z,e);z=dc(z,a);return z;}MatWrap cm(vec3 f,float v,float e,float y){vec3 m=f;float x=dy(m,F*v,r*v);MatWrap a=MatWrap(x,de(e,m));if(a.f<1){float z=length(m.xz)-F*v,s=atan(m.z,m.x);vec2 i=vec2(z,m.y);bw(i,s/4.*d+K*bj);ct(i,vec2(0.));bw(i,K*bh);a.f=do(i,vec2(.5,1.)*r*v);a.m.coord=vec3(i,s);}vec3 z=f;by(z,K*bi);z.x-=F*v;bz(z,K/8.+K*bj-K*bi/4.*d);cr(z.xy,vec2(D*r*sqrt(.5)*v));float s=df(z,q*v);MatWrap i=MatWrap(s,de(y,z));return da(a,i);}MatWrap dl(vec3 f){f.y-=k;vec3 v=f;MatWrap e=cm(v,z,ax,ay);vec3 y=v;by(y,K/6.);bv(y.xz,6.,0.);y.x-=F*z;y.z=-y.z;float m=a*z;MatWrap x=cm(y.xzy,m,az,ba);return da(e,x);}MatWrap ed(vec3 f,float v){ct(f.zyx,vec3(v*x));bx(f,K*be);float e=ct(f.yz,vec2(v*c),v*L);return MatWrap(e,de(bb,f));}MatWrap dm(vec3 f){cr(f.xz,m.xz);f.y-=m.y;by(f,K*y);MatWrap v=ed(f,1.);return v;}float dn(vec3 f){MatWrap v=dk(f);da(v.f,v.m);MatWrap y=dm(f);cc(y.f,y.m,e,bc);MatWrap m=dl(f);da(m.f,m.m);return A;}float ee(vec3 f,bool v){A=G;B=v;if(as)da(dj(f),de(aj,f));if(ar)dn(f);return A;}vec3 ef(vec3 f,float v){vec3 e[6]=vec3[6](vec3(v,0,0),vec3(0,v,0),vec3(0,0,v),vec3(-v,0,0),vec3(0,-v,0),vec3(0,0,-v));float y[6]=float[6](0,0,0,0,0,0);for(int m=0;m<6;m++)y[m]=ee(f+e[m],false);return vec3(y[0]-y[3],y[1]-y[4],y[2]-y[5]);}vec3 eg(vec3 f,float v){return normalize(ef(f,v));}vec3 do(vec3 f){float v=max(5e-05,by(distance(f,T)));v*=af;return do(f,v);}vec3 eh(vec3 f,vec3 v){vec3 e=do(f);if(dot(v,e)>0.){e=normalize(dFdx(e)+e);if(dot(v,e)>0.)e=normalize(dFdy(e)+e);}return e;}vec3 ei(vec3 f,float v){return ef(f,v)/(2.*v);}vec3 dp(vec3 f){float v=max(5e-05,by(distance(f,T)));v*=af;return dp(f,v);}float bk(vec3 f,vec3 v,float e,float y,float m,int x,float a,bool z){float s=e,i=E,M=e,c=0,p=0,r=cs(ee(f,false));for(int d=0;d<x;++d){float n=r*ee(v*s+f,false),t=abs(n);bool l=a>1&&t+c<p;if(l)p-=a*p,a=1;else p=n*a;c=t;float S=t/s;if(!l&&S<i)M=s,i=S;if(!l&&S<m||s>y){break;}s+=p;}if((s>y||i>m)&&!z)return E;return M;}float dt(vec3 f,vec3 v,float e){float y=bk(f,v,.001,e,by(1),256,1.2,false);if(isinf(y))return y;for(int m=0;m<3;m++)y+=ee(f+y*v,false)-by(y);return y;}vec3 du(vec3 f,vec3 v,float e){ar=am;as=an;float y=ee(f,false);vec3 m=do(f);ar=ak;as=al;vec3 x=dFdx(f),a=dFdy(f);int z=5,s=5;vec3 i=vec3(0);for(int M=0;M<s;M++){for(int c=0;c<z;c++){vec2 p=(vec2(c,M)+.5)/vec2(z,s)-.5;vec3 r=p.x*x+p.y*a;float d=y+dot(m,r);i+=dp(d,v,e);}}return i/float(z*s);}vec3 dv(vec3 f,float v,vec3 e){return du(e,f,v);}vec3 dq(vec3 f){ar=ap;as=aq;vec3 v=dp(f);float e=length(v);ar=ak;as=al;vec3 y=vec3(.18014,.74453,.03288),m=vec3(.71547,.03995,.02537),x=vec3(1.);x=mix(x,y,1.-smoothstep(.8,1.,e));x=mix(x,m,smoothstep(1.,1.2,e));return x;}vec3 bm(vec3 f,float v,vec3 e,vec3 y,vec3 m,MaterialId x,Material a){vec3 z=a.emission;return dl(m,-e,a)+z;}vec3 cn(vec3 f,float v,vec3 e,vec3 y){return y;}Material dr(MaterialId e){Material y=de(vec3(1));y.roughness=.1;vec3 m=vec3(38,62,54)/255.,x=vec3(49,90,85)/255.,a=vec3(26,76,107)/255.,z=vec3(59,121,165)/255.,i=vec3(108,97,125)/255.;if(e.id==az){vec2 M=abs(e.coord.xy);if(2.*M.x>M.y)y.color=m;else y.color=a;}else if(e.id==ax)y.color=a;else if(e.id==au){y.color=x;float M=pow(e.misc.x,v);M*=br(3.,23.,min(.5,fract(bd))*2.);y.emission=vec3(1.)*1000.*M*f;}else if(e.id==bb)y.color=z;else if(e.id==bc)y.color=a;else if(e.id==av)y.color=i;else if(e.id==aw)y.color=m;else if(e.id==ba){float M=br(3.,23.,min(.5,fract(.5+bd))*2.);y.emission=vec3(1.)*1000.*M*s;}return y;}void main(){bl();vec3 f=T,v=bk();float e=dt(f,v,at);if(isinf(e))Z=dm(f,v,at),Y=at;else{vec3 y=f+e*v;float m=ee(y,true);MaterialId x=j;vec3 a=eh(y,v);if(x.id==aj){vec3 z=dv(f,e,y);if(ao){vec3 s=dq(y);z=mix(z,s,.5);}Material s=de(z);s.roughness=1.;Z=dl(a,-v,s);}else{if(ao){vec3 z=dq(y);Material s=de(z);s.roughness=0.;Z=dl(a,-v,s);}else{Material z=dr(x);z.roughness=cj(z.roughness);Z=bm(f,e,v,y,a,x,z);}}Y=e;}Z=cn(f,e,v,Z);Z*=exp2(l);}
)shader_source";
#endif
